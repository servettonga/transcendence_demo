name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Create deployment config
        run: |
          echo "// This file is auto-generated for GitHub Pages deployment
          window.DEMO_MODE = true;
          window.BASE_PATH = '/transcendence_demo/';" > frontend/js/deploy-config.js

          sed -i 's|<script type="module" src="js/main.js"></script>|<script src="js/deploy-config.js"></script>\n    <script type="module" src="js/main.js"></script>|' frontend/index.html

          touch frontend/.nojekyll

          cat > frontend/404.html << 'EOL'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting...</title>
            <script>
              // Redirect all 404s to the main index.html for client-side routing
              window.location.href = "/transcendence_demo/";
            </script>
          </head>
          <body>
            Redirecting...
          </body>
          </html>
          EOL

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: frontend
          branch: gh-pages
